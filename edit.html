<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント編集</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="config.js"></script>

    <script src="common.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Manrope', 'Noto Sans JP', sans-serif; 
            background: #f4f6f8; 
            margin: 0; 
            padding-bottom: 60px;
            color: #333; 
        }
        
        .wrapper { 
            max-width: 600px; 
            margin: 60px auto 0; /* common.jsのヘッダー分を下げる */
            background: #fff; 
            padding: 40px; 
            border-radius: 12px; 
            border: 1px solid #eee; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
        }
        
        h1 { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 30px; letter-spacing: 1px; }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .note { font-size: 11px; color: #888; margin-top: 5px; line-height: 1.4; }

        input, textarea, select { 
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 14px; box-sizing: border-box; background: #fafafa; font-family: inherit;
        }
        input:focus { border-color: #000; background: #fff; outline: none; }
        
        .btn-submit { width: 100%; padding: 16px; background: #000; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-delete { width: 100%; background: none; border: none; color: #ccc; font-size: 12px; margin-top: 20px; cursor: pointer; text-decoration: underline; }
        .btn-delete:hover { color: red; }
        
        .back-link { display: block; text-align: center; margin-top: 30px; font-size: 12px; color: #999; text-decoration: none; }
    </style>
</head>
<body>
    <div class="wrapper">
        <h1>イベント情報の編集</h1>

        <div class="form-group">
            <label>イベント名</label>
            <input type="text" id="title">
        </div>

        <div class="form-group">
            <label>カテゴリー</label>
            <select id="category">
                <option value="集う">集う</option>
                <option value="学ぶ">学ぶ</option>
                <option value="観る">観る</option>
                <option value="動く">動く</option>
                <option value="貢献する">貢献する</option>
                <option value="その他">その他</option>
            </select>
        </div>

        <div class="form-group">
            <label>現在の画像</label>
            <div id="current-image-preview" style="margin-bottom:10px;"></div>
            <input type="file" id="image" accept="image/*">
            <div class="note">
                ※ 画像を変更する場合のみ選択してください。<br>
                ※ 自動でトリミング表示されます（推奨：16:9）
            </div>
        </div>

        <div class="form-group">
            <label>短い説明</label>
            <input type="text" id="short_desc">
        </div>

        <div class="form-group">
            <label>開催日</label>
            <input type="date" id="start_date">
        </div>

        <div class="form-group">
            <label>詳細説明</label>
            <textarea id="description" rows="8"></textarea>
        </div>

        <button class="btn-submit" onclick="updateEvent()">情報を更新する</button>
        <button class="btn-delete" onclick="deleteEvent()">このイベントを削除する</button>
        <a href="javascript:history.back()" class="back-link">キャンセルして戻る</a>
    </div>

    <script>
        // supabaseClient は config.js で定義済み！
        const ADMIN_EMAIL = "kanaimori2024@gmail.com";

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const { data: { user } } = await supabaseClient.auth.getUser();

            if (!user) return window.location.href = 'login.html';

            const { data: event, error } = await supabaseClient.from('events').select('*').eq('id', id).single();
            if(error) return alert("データ取得エラー");

            // 権限チェック（自分のイベント OR 管理者 ならOK）
            if (event.user_id !== user.id && user.email !== ADMIN_EMAIL) {
                alert("編集権限がありません");
                window.location.href = 'index.html';
                return;
            }

            // フォームに値をセット
            document.getElementById('title').value = event.title;
            document.getElementById('category').value = event.category || 'その他';
            document.getElementById('short_desc').value = event.short_desc || '';
            document.getElementById('start_date').value = event.date;
            document.getElementById('description').value = event.description || '';
            
            if(event.image_url) {
                document.getElementById('current-image-preview').innerHTML = 
                    `<img src="${event.image_url}" width="120" style="border-radius:6px; border:1px solid #eee; object-fit:cover;">`;
            }
        }

        async function updateEvent() {
            const id = new URLSearchParams(window.location.search).get('id');
            const file = document.getElementById('image').files[0];
            
            let updates = {
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                short_desc: document.getElementById('short_desc').value,
                date: document.getElementById('start_date').value,
                description: document.getElementById('description').value
            };

            if(file) {
                const fileName = Date.now() + '_' + file.name;
                await supabaseClient.storage.from('images').upload(fileName, file);
                const { data } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                updates.image_url = data.publicUrl;
            }

            const { error } = await supabaseClient.from('events').update(updates).eq('id', id);
            if(error) alert(error.message);
            else { 
                alert("更新しました！"); 
                // 管理者ならスーパー管理画面へ、一般ならマイページへ
                const { data: { user } } = await supabaseClient.auth.getUser();
                if(user.email === ADMIN_EMAIL) window.location.href = 'super_admin.html';
                else window.location.href = 'mypage.html';
            }
        }

        async function deleteEvent() {
            if(!confirm("本当に削除しますか？")) return;
            const id = new URLSearchParams(window.location.search).get('id');
            await supabaseClient.from('events').delete().eq('id', id);
            
            // 戻り先を振り分け
            const { data: { user } } = await supabaseClient.auth.getUser();
            if(user.email === ADMIN_EMAIL) window.location.href = 'super_admin.html';
            else window.location.href = 'mypage.html';
        }

        init();
    </script>
</body>
</html>