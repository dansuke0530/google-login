<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント登録</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', 'Noto Sans JP', sans-serif; background: #f4f6f8; margin: 0; padding: 40px 20px; color: #333; }
        .wrapper { max-width: 600px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        
        h1 { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 30px; letter-spacing: 1px; }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .note { font-size: 11px; color: #888; margin-top: 5px; line-height: 1.4; }
        
        input, textarea, select { 
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 14px; box-sizing: border-box; background: #fafafa; font-family: inherit;
        }
        input:focus { border-color: #000; background: #fff; outline: none; }
        
        .btn-submit { width: 100%; padding: 16px; background: #000; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-submit:hover { opacity: 0.8; }
        
        .back-link { display: block; text-align: center; margin-top: 30px; font-size: 12px; color: #999; text-decoration: none; }
    </style>
</head>
<body>
    <div class="wrapper">
        <h1>新規イベント登録</h1>

        <div class="form-group">
            <label>イベント名 (必須)</label>
            <input type="text" id="title" placeholder="例：Webデザイン交流会 vol.1">
        </div>

        <div class="form-group">
            <label>カテゴリー</label>
            <select id="category">
                <option value="集う">集う</option>
                <option value="学ぶ">学ぶ</option>
                <option value="観る">観る</option>
                <option value="動く">動く</option>
                <option value="貢献する">貢献する</option>
                <option value="その他">その他</option>
            </select>
        </div>

        <div class="form-group">
            <label>メイン画像</label>
            <input type="file" id="image" accept="image/*">
            <div class="note">
                ※ サイズ制限はありません。自動で綺麗にトリミング（切り抜き表示）されます。<br>
                ※ 推奨比率は 16:9（横長）や 4:3 です。
            </div>
        </div>

        <div class="form-group">
            <label>短い説明 (一覧表示用)</label>
            <input type="text" id="short_desc" placeholder="30文字程度で簡潔に">
        </div>

        <div class="form-group">
            <label>開催日 (必須)</label>
            <input type="date" id="start_date">
        </div>

        <div class="form-group">
            <label>詳細説明</label>
            <textarea id="description" rows="6" placeholder="イベントの詳細内容を入力してください"></textarea>
        </div>

        <button class="btn-submit" onclick="addEvent()">イベントを登録する</button>
        <a href="javascript:history.back()" class="back-link">キャンセルして戻る</a>
    </div>

    <script>
        const supabaseUrl = 'https://daexakehxcvspmthpzzf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZXhha2VoeGN2c3BtdGhwenpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjc0ODgsImV4cCI6MjA4MzgwMzQ4OH0.xpHRjDPWlch_D80v1QQ9k_CJV6Q39pDa5f9qQ470rMI';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        async function addEvent() {
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const short_desc = document.getElementById('short_desc').value;
            const description = document.getElementById('description').value;
            const startDate = document.getElementById('start_date').value;
            const imageFile = document.getElementById('image').files[0];

            if (!title || !startDate) return alert("タイトルと日付は必須です");

            const { data: { user } } = await supabaseClient.auth.getUser();
            if(!user) return alert("ログインしてください");

            try {
                let imageUrl = null;
                if (imageFile) {
                    const fileName = Date.now() + '_' + imageFile.name;
                    await supabaseClient.storage.from('images').upload(fileName, imageFile);
                    const { data } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                    imageUrl = data.publicUrl;
                }

                const { error } = await supabaseClient.from('events').insert([{
                    title, category, short_desc, description, date: startDate, 
                    image_url: imageUrl, user_id: user.id
                }]);

                if (error) throw error;
                alert("登録しました！");
                window.location.href = 'mypage.html';
            } catch (error) {
                alert("エラー: " + error.message);
            }
        }
    </script>

    <script src="chat.js"></script>
</body>
</html>
