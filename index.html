<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventSite | ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="config.js"></script>
    <script src="common.js"></script>
    <script src="sidebar.js"></script> <script src="chat.js?v=2"></script>

    <style>
        /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆevent.htmlã¨åŒã˜æ§‹é€ ï¼‰ */
        .page-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .main-content { flex: 1; min-width: 0; }
        .sidebar-area { width: 300px; flex-shrink: 0; }

        @media (max-width: 768px) {
            .page-container { flex-direction: column; }
            .sidebar-area { width: 100%; order: -1; /* ã‚¹ãƒãƒ›ã§ã¯æ¤œç´¢ã‚’ä¸Šã«æŒã£ã¦ãã‚‹ */ margin-bottom: 20px;}
        }

        /* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .event-list { display: grid; gap: 20px; }
        .event-card {
            display: flex; gap: 20px; border: 1px solid #eee; border-radius: 12px;
            overflow: hidden; background: #fff; transition: 0.3s;
            cursor: pointer; text-decoration: none; color: inherit;
        }
        .event-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-thumb { width: 200px; height: 100%; object-fit: cover; background: #eee; }
        .card-info { padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-date { color: #888; font-size: 12px; margin-bottom: 5px; }
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .card-desc { font-size: 13px; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @media (max-width: 600px) {
            .event-card { flex-direction: column; }
            .card-thumb { width: 100%; height: 150px; }
        }
        
        /* æ¤œç´¢çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .filter-msg { 
            background: #f0f0f0; padding: 10px 20px; border-radius: 8px; 
            margin-bottom: 20px; font-size: 14px; display: none; 
        }
    </style>
</head>
<body>

    <div class="page-container">
        
        <div class="main-content">
            <div id="filter-message" class="filter-msg"></div>

            <div id="event-list" class="event-list">
                <div>èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <div class="sidebar-area">
            <div id="sidebar-placeholder"></div>
        </div>

    </div>

    <script>
        // â˜…ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ï¼†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çµ±åˆãƒ­ã‚¸ãƒƒã‚¯
        window.addEventListener('load', async () => {
            
            // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆsidebar.jsã‹ã‚‰é£›ã‚“ã§ããŸå ´åˆï¼‰
            const params = new URLSearchParams(window.location.search);
            const searchKeyword = params.get('q');   // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰
            const categoryTag = params.get('cat');   // ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚°

            // 2. ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¨ä»¶å–å¾—
            const { data: events, error } = await supabaseClient
                .from('events')
                .select('*')
                .order('date', { ascending: true }); // æ—¥ä»˜é †

            if (error) {
                document.getElementById('event-list').innerHTML = '<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                console.error(error);
                return;
            }

            let filteredEvents = events;
            const msgEl = document.getElementById('filter-message');

            // 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ
            if (searchKeyword) {
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
                filteredEvents = events.filter(e => 
                    e.title.includes(searchKeyword) || 
                    (e.description && e.description.includes(searchKeyword))
                );
                msgEl.style.display = 'block';
                msgEl.innerHTML = `ğŸ” <strong>ã€Œ${searchKeyword}ã€</strong> ã®æ¤œç´¢çµæœ (${filteredEvents.length}ä»¶) <a href="index.html" style="float:right; color:#000;">ã‚¯ãƒªã‚¢ Ã—</a>`;
            
                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ¤œç´¢çª“ã«ã‚‚è¨€è‘‰ã‚’å…¥ã‚Œã¦ãŠãï¼ˆUXå‘ä¸Šï¼‰
                setTimeout(() => {
                    const input = document.getElementById('common-search-input');
                    if(input) input.value = searchKeyword;
                }, 500);

            } else if (categoryTag) {
                // ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢
                filteredEvents = events.filter(e => e.category === categoryTag);
                msgEl.style.display = 'block';
                msgEl.innerHTML = `ğŸ·ï¸ <strong>Category: ${categoryTag}</strong> (${filteredEvents.length}ä»¶) <a href="index.html" style="float:right; color:#000;">ã‚¯ãƒªã‚¢ Ã—</a>`;
            }

            // 4. ä¸€è¦§ã‚’è¡¨ç¤º
            const listContainer = document.getElementById('event-list');
            listContainer.innerHTML = '';

            if (filteredEvents.length === 0) {
                listContainer.innerHTML = '<p>è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            filteredEvents.forEach(event => {
                const img = event.image_url || 'https://placehold.co/400x200/eee/999?text=No+Image';
                const html = `
                    <a href="event.html?id=${event.id}" class="event-card">
                        <img src="${img}" class="card-thumb" alt="${event.title}">
                        <div class="card-info">
                            <div class="card-date">ğŸ“… ${event.date} | ${event.category}</div>
                            <div class="card-title">${event.title}</div>
                            <div class="card-desc">${event.short_desc || event.description || ''}</div>
                        </div>
                    </a>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        });
    </script>
</body>
</html>